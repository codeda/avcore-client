!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("axios"),require("socket.io-client")):"function"==typeof define&&define.amd?define(["axios","socket.io-client"],t):"object"==typeof exports?exports.avcore=t(require("axios"),require("socket.io-client")):e.avcore=t(e.axios,e.io)}(this,(function(e,t){return function(e){var t={};function i(r){if(t[r])return t[r].exports;var n=t[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,i),n.l=!0,n.exports}return i.m=e,i.c=t,i.d=function(e,t,r){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)i.d(r,n,function(t){return e[t]}.bind(null,n));return r},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=2)}([function(t,i){t.exports=e},function(e,i){e.exports=t},function(e,t,i){"use strict";var r;i.r(t),i.d(t,"ERROR",(function(){return S})),i.d(t,"ACTION",(function(){return r})),i.d(t,"API_OPERATION",(function(){return T})),i.d(t,"CODEC",(function(){return a})),i.d(t,"EVENT",(function(){return s})),i.d(t,"STAT",(function(){return u})),i.d(t,"INFO",(function(){return E})),i.d(t,"MIXER_PIPE_TYPE",(function(){return _})),i.d(t,"NEXMO",(function(){return c})),i.d(t,"HLS",(function(){return d})),i.d(t,"PATH",(function(){return R})),i.d(t,"SOCKET_ONLY_ACTIONS",(function(){return n})),i.d(t,"REST_ACTIONS",(function(){return o})),i.d(t,"MIXER_RENDER_TYPE",(function(){return l})),i.d(t,"MediasoupSocketApi",(function(){return A})),i.d(t,"NexmoUtils",(function(){return p})),i.d(t,"CloudApi",(function(){return f})),function(e){e.GET_SERVER_CONFIGS="getServerConfigs",e.CREATE_TRANSPORT="createTransport",e.CONNECT_TRANSPORT="connectTransport",e.CLOSE_TRANSPORT="closeTransport",e.PRODUCE="produce",e.CONSUME="consume",e.RESUME_CONSUMER="resumeConsumer",e.PAUSE_CONSUMER="pauseConsumer",e.CLOSE_CONSUMER="closeConsumer",e.RESUME_PRODUCER="resumeProducer",e.PAUSE_PRODUCER="pauseProducer",e.CLOSE_PRODUCER="closeProducer",e.FILE_STREAMING="fileStreaming",e.LIVE_STREAMING="liveStreaming",e.FILE_STREAMING_OPTIONS="fileStreamingOptions",e.LIVE_TO_HLS="liveToHls",e.TCP_STREAMING="tcpStreaming",e.STOP_FILE_STREAMING="stopFileStreaming",e.START_RECORDING="startRecording",e.STOP_RECORDING="stopRecording",e.CREATE_PIPE_TRANSPORT="createPipeTransport",e.CONNECT_PIPE_TRANSPORT="connectPipeTransport",e.SET_PREFERRED_LAYERS="setPreferredLayers",e.SET_MAX_INCOMING_BITRATE="setMaxIncomingBitrate",e.PRODUCERS_STATS="producersStats",e.PRODUCERS_STATS_BY_STREAM="producersStatsByStream",e.CONSUMERS_STATS="consumersStats",e.TRANSPORT_STATS="transportStats",e.PIPE_TO_REMOTE_PRODUCER="pipeToRemoteProducer",e.PIPE_FROM_REMOTE_PRODUCER="pipeFromRemoteProducer",e.WORKER_LOAD="workerLoad",e.NUM_WORKERS="numWorkers",e.RECORDED_STREAMS="recordedStreams",e.STREAM_RECORDINGS="streamRecordings",e.DELETE_STREAM_RECORDINGS="deleteStreamRecordings",e.DELETE_RECORDING="deleteRecording",e.PUSH_TO_SERVER_INPUTS="pushToServerInputs",e.PULL_FROM_SERVER_INPUTS="pullFromServerInputs",e.PUSH_TO_SERVER_OPTIONS="pushToServerOptions",e.PUSH_TO_SERVER="pushToServer",e.KINDS_BY_FILE="kindsByFile",e.REQUEST_KEYFRAME="requestKeyframe",e.LISTEN_STREAM_STARTED="listenStreamStarted",e.LISTEN_STREAM_STOPPED="listenStreamStopped",e.ALLOCATE_PORT="allocatePort",e.RELEASE_PORT="releasePort",e.MIXER_START="mixerStart",e.MIXER_CLOSE="mixerClose",e.MIXER_ADD="mixerAdd",e.MIXER_ADD_FILE="mixerAddFile",e.MIXER_ADD_TCP="mixerAddTcp",e.MIXER_REMOVE="mixerRemove",e.MIXER_UPDATE="mixerUpdate",e.MIXER_PIPE_START="mixerPipeStart",e.MIXER_PIPE_STOP="mixerPipeStop",e.MIXER_COMMAND="mixerCommand",e.LISTEN_MIXER_STOPPED="listenMixerStopped",e.LISTEN_MIXER_FILE_STARTED="listenMixerFileStarted",e.LISTEN_MIXER_FILE_STOPPED="listenMixerFileStopped",e.CLEAR_PIPE_TRANSPORTS="clearPipeTransports",e.HEAP_SNAPSHOT="heapSnapshot"}(r||(r={}));const n=[r.GET_SERVER_CONFIGS,r.CREATE_TRANSPORT,r.CONNECT_TRANSPORT,r.CLOSE_TRANSPORT,r.PRODUCE,r.CONSUME,r.LISTEN_STREAM_STARTED,r.LISTEN_STREAM_STOPPED,r.LISTEN_MIXER_STOPPED,r.LISTEN_MIXER_FILE_STARTED,r.LISTEN_MIXER_FILE_STOPPED,r.CREATE_PIPE_TRANSPORT,r.CONNECT_PIPE_TRANSPORT,r.PIPE_TO_REMOTE_PRODUCER,r.PIPE_FROM_REMOTE_PRODUCER],o=Object.values(r).filter(e=>!n.includes(e));var s,u,E;!function(e){e.STREAM_STARTED="streamStarted",e.STREAM_STOPPED="streamStopped",e.MIXER_STOPPED="mixerStopped",e.MIXER_FILE_STARTED="mixerFileStarted",e.MIXER_FILE_STOPPED="mixerFileStopped"}(s||(s={})),function(e){e.STATS="stats",e.TRAFFIC="traffic",e.CPU="cpu",e.STREAM="stream"}(u||(u={})),function(e){e.INFO="info",e.MCU="mcu",e.GST="gst"}(E||(E={}));const d={ROOT:"hls",PLAYLIST:"master.m3u8"};var R;!function(e){e.API="api"}(R||(R={}));const c={PATH:"nexmo",AUDIO_SAMPLE_RATE:16e3,AUDIO_CHANNELS:1};var S,T,_,l,a;!function(e){e[e.UNKNOWN=500]="UNKNOWN",e[e.UNAUTHORIZED=401]="UNAUTHORIZED",e[e.INVALID_TRANSPORT=530]="INVALID_TRANSPORT",e[e.INVALID_PRODUCER=531]="INVALID_PRODUCER",e[e.INVALID_CONSUMER=532]="INVALID_CONSUMER",e[e.INVALID_STREAM=533]="INVALID_STREAM",e[e.INVALID_OPERATION=534]="INVALID_OPERATION",e[e.INVALID_WORKER=535]="INVALID_WORKER",e[e.INVALID_INPUT=536]="INVALID_INPUT",e[e.INVALID_ACTION=537]="INVALID_ACTION"}(S||(S={})),function(e){e[e.SUBSCRIBE=0]="SUBSCRIBE",e[e.PUBLISH=1]="PUBLISH",e[e.RECORDING=2]="RECORDING",e[e.STREAMING=3]="STREAMING",e[e.MIXER=4]="MIXER"}(T||(T={})),function(e){e[e.LIVE=0]="LIVE",e[e.RECORDING=1]="RECORDING",e[e.RTMP=2]="RTMP",e[e.HLS=3]="HLS",e[e.PORT=4]="PORT"}(_||(_={})),function(e){e.SCALE="scale",e.CROP="crop",e.PAD="pad"}(l||(l={})),function(e){e.OPUS="opus",e.H264="h264",e.VP8="vp8"}(a||(a={}));var h=i(1),O=i(0),I=i.n(O),P=function(e,t,i,r){return new(i||(i=Promise))((function(n,o){function s(e){try{E(r.next(e))}catch(e){o(e)}}function u(e){try{E(r.throw(e))}catch(e){o(e)}}function E(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,u)}E((r=r.apply(e,t||[])).next())}))};class A{constructor(e,t,i,r,n){this.closed=!1,this.log=r||console.log,this.url=e,this.worker=t,this.token=i,this.cloudApi=n}get client(){return this._client||(this._client=Object(h.io)(this.url,{path:"",transports:["websocket"],query:{auth_token:this.token,mediasoup_worker:this.worker},forceNew:!0})),this._client}connectSocket(){return new Promise((e,t)=>{this.client.connected?e():(this.client.on("error",e=>{"Not enough or too many segments"===e.message?e.errorId=S.UNAUTHORIZED:e.errorId=S.UNKNOWN,t(e)}),this.client.on("connect",e))})}resumeConsumer(e){return P(this,void 0,void 0,(function*(){yield this.request(r.RESUME_CONSUMER,e)}))}pauseConsumer(e){return P(this,void 0,void 0,(function*(){yield this.request(r.PAUSE_CONSUMER,e)}))}setPreferredLayers(e){return P(this,void 0,void 0,(function*(){yield this.request(r.SET_PREFERRED_LAYERS,e)}))}closeConsumer(e){return P(this,void 0,void 0,(function*(){yield this.request(r.CLOSE_CONSUMER,e)}))}resumeProducer(e){return P(this,void 0,void 0,(function*(){yield this.request(r.RESUME_PRODUCER,e)}))}pauseProducer(e){return P(this,void 0,void 0,(function*(){yield this.request(r.PAUSE_PRODUCER,e)}))}closeProducer(e){return P(this,void 0,void 0,(function*(){yield this.request(r.CLOSE_PRODUCER,e)}))}produce(e){return P(this,void 0,void 0,(function*(){return yield this.request(r.PRODUCE,e)}))}consume(e){return P(this,void 0,void 0,(function*(){return yield this.request(r.CONSUME,e)}))}createPipeTransport(){return P(this,void 0,void 0,(function*(){return yield this.request(r.CREATE_PIPE_TRANSPORT)}))}connectPipeTransport(e){return P(this,void 0,void 0,(function*(){yield this.request(r.CONNECT_PIPE_TRANSPORT,e)}))}closeTransport(e){return P(this,void 0,void 0,(function*(){yield this.request(r.CLOSE_TRANSPORT,e)}))}getServerConfigs(){return P(this,void 0,void 0,(function*(){return yield this.request(r.GET_SERVER_CONFIGS)}))}createTransport(){return P(this,void 0,void 0,(function*(){return yield this.request(r.CREATE_TRANSPORT)}))}connectTransport(e){return P(this,void 0,void 0,(function*(){yield this.request(r.CONNECT_TRANSPORT,e)}))}setMaxIncomingBitrate(e){return P(this,void 0,void 0,(function*(){yield this.request(r.SET_MAX_INCOMING_BITRATE,e)}))}producersStats(e){return P(this,void 0,void 0,(function*(){return yield this.request(r.PRODUCERS_STATS,e)}))}producersStatsByStream(e){return P(this,void 0,void 0,(function*(){return yield this.request(r.PRODUCERS_STATS_BY_STREAM,e)}))}consumersStats(e){return P(this,void 0,void 0,(function*(){return yield this.request(r.CONSUMERS_STATS,e)}))}transportStats(e){return P(this,void 0,void 0,(function*(){return yield this.request(r.TRANSPORT_STATS,e)}))}workerLoad(){return P(this,void 0,void 0,(function*(){return yield this.request(r.WORKER_LOAD)}))}numWorkers(){return P(this,void 0,void 0,(function*(){return yield this.request(r.NUM_WORKERS)}))}pipeToRemoteProducer(e){return P(this,void 0,void 0,(function*(){yield this.request(r.PIPE_TO_REMOTE_PRODUCER,e)}))}pipeFromRemoteProducer(e){return P(this,void 0,void 0,(function*(){yield this.request(r.PIPE_FROM_REMOTE_PRODUCER,e)}))}startRecording(e){return P(this,void 0,void 0,(function*(){!e.origin&&this.cloudApi&&(e.origin=yield this.cloudApi.streamOrigin(this,e.stream)),yield this.request(r.START_RECORDING,e)}))}stopRecording(e){return P(this,void 0,void 0,(function*(){yield this.request(r.STOP_RECORDING,e)}))}fileStreaming(e){return P(this,void 0,void 0,(function*(){yield this.request(r.FILE_STREAMING,e)}))}stopFileStreaming(e){return P(this,void 0,void 0,(function*(){yield this.request(r.STOP_FILE_STREAMING,e)}))}fileStreamingOptions(e){return P(this,void 0,void 0,(function*(){return yield this.request(r.FILE_STREAMING_OPTIONS,e)}))}recordedStreams(){return P(this,void 0,void 0,(function*(){return yield this.request(r.RECORDED_STREAMS)}))}streamRecordings(e){return P(this,void 0,void 0,(function*(){return yield this.request(r.STREAM_RECORDINGS,e)}))}deleteStreamRecordings(e){return P(this,void 0,void 0,(function*(){yield this.request(r.DELETE_STREAM_RECORDINGS,e)}))}deleteRecording(e){return P(this,void 0,void 0,(function*(){yield this.request(r.DELETE_RECORDING,e)}))}pushToServerInputs(e){return P(this,void 0,void 0,(function*(){return yield this.request(r.PUSH_TO_SERVER_INPUTS,e)}))}pushToServerOptions(e){return P(this,void 0,void 0,(function*(){return yield this.request(r.PUSH_TO_SERVER_OPTIONS,e)}))}pushToServer(e){return P(this,void 0,void 0,(function*(){yield this.request(r.PUSH_TO_SERVER,e)}))}pullFromServerInputs(e){return P(this,void 0,void 0,(function*(){return yield this.request(r.PULL_FROM_SERVER_INPUTS,e)}))}kindsByFile(e){return P(this,void 0,void 0,(function*(){return yield this.request(r.KINDS_BY_FILE,e)}))}requestKeyframe(e){return P(this,void 0,void 0,(function*(){yield this.request(r.REQUEST_KEYFRAME,e)}))}listenStreamStarted(e){return P(this,void 0,void 0,(function*(){return yield this.request(r.LISTEN_STREAM_STARTED,e)}))}listenStreamStopped(e){return P(this,void 0,void 0,(function*(){return yield this.request(r.LISTEN_STREAM_STOPPED,e)}))}liveStreaming(e){return P(this,void 0,void 0,(function*(){yield this.request(r.LIVE_STREAMING,e)}))}liveToHls(e){return P(this,void 0,void 0,(function*(){return yield this.request(r.LIVE_TO_HLS,e)}))}tcpStreaming(e){return P(this,void 0,void 0,(function*(){return yield this.request(r.TCP_STREAMING,e)}))}allocatePort(){return P(this,void 0,void 0,(function*(){return yield this.request(r.ALLOCATE_PORT)}))}releasePort(e){return P(this,void 0,void 0,(function*(){yield this.request(r.RELEASE_PORT,e)}))}mixerStart(e){return P(this,void 0,void 0,(function*(){return yield this.request(r.MIXER_START,e)}))}mixerClose(e){return P(this,void 0,void 0,(function*(){yield this.request(r.MIXER_CLOSE,e)}))}mixerAdd(e){return P(this,void 0,void 0,(function*(){!e.origin&&this.cloudApi&&(e.origin=yield this.cloudApi.streamOrigin(this,e.stream)),yield this.request(r.MIXER_ADD,e)}))}mixerAddTcp(e){return P(this,void 0,void 0,(function*(){yield this.request(r.MIXER_ADD_TCP,e)}))}mixerAddFile(e){return P(this,void 0,void 0,(function*(){yield this.request(r.MIXER_ADD_FILE,e)}))}mixerUpdate(e){return P(this,void 0,void 0,(function*(){yield this.request(r.MIXER_UPDATE,e)}))}mixerRemove(e){return P(this,void 0,void 0,(function*(){yield this.request(r.MIXER_REMOVE,e)}))}mixerPipeStart(e){return P(this,void 0,void 0,(function*(){return yield this.request(r.MIXER_PIPE_START,e)}))}mixerPipeStop(e){return P(this,void 0,void 0,(function*(){yield this.request(r.MIXER_PIPE_STOP,e)}))}mixerCommand(e){return P(this,void 0,void 0,(function*(){yield this.request(r.MIXER_COMMAND,e)}))}listenMixerStopped(e){return P(this,void 0,void 0,(function*(){return yield this.request(r.LISTEN_MIXER_STOPPED,e)}))}listenMixerFileStarted(e){return P(this,void 0,void 0,(function*(){return yield this.request(r.LISTEN_MIXER_FILE_STARTED,e)}))}listenMixerFileStopped(e){return P(this,void 0,void 0,(function*(){return yield this.request(r.LISTEN_MIXER_FILE_STOPPED,e)}))}clearPipeTransports(e){return P(this,void 0,void 0,(function*(){yield this.request(r.CLEAR_PIPE_TRANSPORTS,e)}))}heapSnapshot(){return P(this,void 0,void 0,(function*(){yield this.request(r.HEAP_SNAPSHOT)}))}hlsUrl(e){return`${this.url}/${d.ROOT}/${e}/${d.PLAYLIST}`}location(){return this.url}streamOrigin(e){if(e&&e.url!==this.url){const{url:t,token:i,worker:r}=this;return{source:e,target:{url:t,token:i,worker:r}}}}clear(){this.closed=!0,this._client&&(this._client.removeAllListeners(),this.client.connected&&this._client.disconnect())}request(e){return P(this,arguments,void 0,(function*(e,t={}){if(!this.closed)return this._client||n.includes(e)||e===r.MIXER_START&&t.closeOnDisconnected?this.socketRequest(e,t):this.restRequest(e,t)}))}socketRequest(e){return P(this,arguments,void 0,(function*(e,t={}){return yield this.connectSocket(),this.log("sent message",e,JSON.stringify(t)),new Promise((i,r)=>{this.client.emit(e,t,t=>{t&&"boolean"!=typeof t&&t.hasOwnProperty("errorId")?(this.log("got error",e,JSON.stringify(t)),r(t)):(this.log("got message",e,JSON.stringify(t)),i(t))})})}))}restRequest(e){return P(this,arguments,void 0,(function*(e,t={}){try{const{data:i}=yield I.a.post(`${this.url}/${R.API}/${this.worker}/${e}`,t,{headers:{"Content-Type":"application/json",Authorization:"Bearer "+this.token}});return this.log("got message",e,JSON.stringify(i)),i}catch(e){let t=S.UNKNOWN;throw this.log("got error",e),e.response&&e.response.status&&S[e.response.status]&&(t=e.response.status),{errorId:t}}}))}}class p{static pinCodeChoice(e,t,i="Please, enter active pin code."){return[{action:"talk",text:i,bargeIn:!0},{action:"input",maxDigits:e,timeOut:10,eventUrl:[t]}]}static pinCodeChoiceRepeat(e,t,i="Sorry, this pin code is invalid.",r){return[{action:"talk",text:i},...p.pinCodeChoice(e,t,r)]}static mixerConnect(e,t,i="Connecting to meeting. Please, wait."){return[{action:"talk",text:i},{action:"connect",endpoint:[{type:"websocket",uri:`${e.replace("http","ws")}/${c.PATH}`,"content-type":"audio/l16;rate="+c.AUDIO_SAMPLE_RATE,headers:t}]}]}}var v=function(e,t,i,r){return new(i||(i=Promise))((function(n,o){function s(e){try{E(r.next(e))}catch(e){o(e)}}function u(e){try{E(r.throw(e))}catch(e){o(e)}}function E(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,u)}E((r=r.apply(e,t||[])).next())}))};class f{constructor(e,t,i){this.url=e,this.token=t,this.log=i}create(e,t,i){return v(this,void 0,void 0,(function*(){const{data:{config:{url:r,worker:n,token:o}}}=yield I.a.post(this.url+"/api/customer/config/api",{operation:e,mixerId:t,stream:i},{headers:{"Content-Type":"application/json",Authorization:"Bearer "+this.token}});return new A(r,n,o,this.log,this)}))}streamOrigin(e,t){return v(this,void 0,void 0,(function*(){const{data:{config:{url:i,worker:r,token:n}}}=yield I.a.post(this.url+"/api/customer/config/sdk",{operation:T.PUBLISH,stream:t},{headers:{"Content-Type":"application/json",Authorization:"Bearer "+this.token}});return e.streamOrigin({url:i,worker:r,token:n})}))}}}])}));